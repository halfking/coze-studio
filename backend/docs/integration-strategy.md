# CozeRights ä¸ Coze-Studio æ•´åˆç­–ç•¥

## ğŸ¯ æ•´åˆç›®æ ‡

åŸºäºå¯¹Coze-Studioæºç çš„æ·±åº¦åˆ†æï¼Œåˆ¶å®šä¼ä¸šçº§æƒé™ç®¡ç†ç³»ç»Ÿçš„æ•´åˆç­–ç•¥ï¼Œå®ç°ï¼š
- **æ— ç¼é›†æˆ**ï¼šä¿æŒCoze-Studioç°æœ‰åŠŸèƒ½çš„åŒæ—¶å¢å¼ºä¼ä¸šçº§èƒ½åŠ›
- **å‘åå…¼å®¹**ï¼šç¡®ä¿ç°æœ‰APIå’Œæ•°æ®çš„å…¼å®¹æ€§
- **æ¸è¿›å¼å‡çº§**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œé™ä½é£é™©
- **ç”¨æˆ·ä½“éªŒ**ï¼šç»Ÿä¸€çš„ç”¨æˆ·ç•Œé¢å’Œäº¤äº’ä½“éªŒ

## ğŸ—ï¸ æŠ€æœ¯æ•´åˆç­–ç•¥

### 1. æ¶æ„æ•´åˆæ–¹æ¡ˆ

#### 1.1 å¾®æœåŠ¡æ¶æ„è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Coze-Studio Frontend (Enhanced)                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   Agent     â”‚  â”‚  Workflow   â”‚  â”‚    Plugin       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    IDE      â”‚  â”‚    IDE      â”‚  â”‚     IDE         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         Enterprise Management UI                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  (Tenant/Workspace/Permission Management)          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Unified API Gateway                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚    Auth     â”‚  â”‚ Permission  â”‚  â”‚     Routing     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Middleware  â”‚  â”‚ Middleware  â”‚  â”‚   Middleware    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Backend Services Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                CozeRights Service                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   Tenant    â”‚  â”‚    User     â”‚  â”‚   Workspace     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚    Service      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚    RBAC     â”‚  â”‚    Audit    â”‚  â”‚    Resource     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚    Service      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Coze-Studio Service (Enhanced)              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   Agent     â”‚  â”‚  Workflow   â”‚  â”‚    Plugin       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚   Service       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 æ•°æ®å±‚æ•´åˆè®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Data Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Unified Database                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  CozeRights â”‚  â”‚ Coze-Studio â”‚  â”‚     Shared      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   Tables    â”‚  â”‚   Tables    â”‚  â”‚    Tables       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â”‚ (Enhanced)  â”‚  â”‚                 â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. APIæ•´åˆç­–ç•¥

#### 2.1 APIç‰ˆæœ¬ç®¡ç†
```go
// ç»Ÿä¸€çš„APIç‰ˆæœ¬ç®¡ç†
const (
    APIVersionV1 = "v1"  // CozeRights API
    APIVersionV2 = "v2"  // æ•´åˆåçš„ç»Ÿä¸€API
    APIVersionLegacy = "legacy" // Coze-Studioå…¼å®¹API
)

// APIè·¯ç”±è®¾è®¡
type APIRouter struct {
    // CozeRights API (ä¿æŒä¸å˜)
    V1Group *gin.RouterGroup // /api/v1/*
    
    // ç»Ÿä¸€API (æ–°å¢)
    V2Group *gin.RouterGroup // /api/v2/*
    
    // å…¼å®¹API (Coze-Studio)
    LegacyGroup *gin.RouterGroup // /api/legacy/*
}
```

#### 2.2 APIé€‚é…å™¨æ¨¡å¼
```go
// APIé€‚é…å™¨æ¥å£
type APIAdapter interface {
    ConvertRequest(req interface{}) (interface{}, error)
    ConvertResponse(resp interface{}) (interface{}, error)
}

// Coze-Studio APIé€‚é…å™¨
type CozeStudioAdapter struct {
    cozeRightsService *CozeRightsService
}

func (a *CozeStudioAdapter) GetSpaceInfo(spaceID string) (*SpaceInfo, error) {
    // 1. è½¬æ¢spaceIDåˆ°workspaceID
    workspaceID := a.convertSpaceIDToWorkspaceID(spaceID)
    
    // 2. è°ƒç”¨CozeRights API
    workspace, err := a.cozeRightsService.GetWorkspace(workspaceID)
    if err != nil {
        return nil, err
    }
    
    // 3. è½¬æ¢å“åº”æ ¼å¼
    return a.convertWorkspaceToSpace(workspace), nil
}
```

### 3. æ•°æ®åŒæ­¥ç­–ç•¥

#### 3.1 æ•°æ®è¿ç§»æ–¹æ¡ˆ
```go
// æ•°æ®è¿ç§»æœåŠ¡
type DataMigrationService struct {
    sourceDB *gorm.DB // Coze-Studioæ•°æ®åº“
    targetDB *gorm.DB // CozeRightsæ•°æ®åº“
}

// ç”¨æˆ·æ•°æ®è¿ç§»
func (s *DataMigrationService) MigrateUsers() error {
    // 1. è¯»å–Coze-Studioç”¨æˆ·æ•°æ®
    var cozeUsers []CozeStudioUser
    s.sourceDB.Find(&cozeUsers)
    
    // 2. è½¬æ¢ä¸ºCozeRightsæ ¼å¼
    for _, cozeUser := range cozeUsers {
        cozeRightsUser := &models.User{
            Username:       cozeUser.UserUniqueName,
            Email:          cozeUser.Email,
            TenantID:       s.getDefaultTenantID(), // åˆ†é…é»˜è®¤ç§Ÿæˆ·
            SystemRole:     "user",
            IsActive:       true,
            // ä¿å­˜åŸå§‹IDç”¨äºå…³è”
            ExternalID:     cozeUser.UserID,
        }
        
        // 3. ä¿å­˜åˆ°CozeRightsæ•°æ®åº“
        s.targetDB.Create(cozeRightsUser)
        
        // 4. è®°å½•IDæ˜ å°„å…³ç³»
        s.recordIDMapping("user", cozeUser.UserID, cozeRightsUser.ID)
    }
    
    return nil
}
```

#### 3.2 å®æ—¶æ•°æ®åŒæ­¥
```go
// æ•°æ®åŒæ­¥äº‹ä»¶
type SyncEvent struct {
    Type       string      `json:"type"`        // create, update, delete
    Resource   string      `json:"resource"`    // user, workspace, agent, etc.
    ResourceID string      `json:"resource_id"`
    Data       interface{} `json:"data"`
    Timestamp  time.Time   `json:"timestamp"`
}

// æ•°æ®åŒæ­¥æœåŠ¡
type DataSyncService struct {
    eventBus   EventBus
    cozeRights *CozeRightsService
    cozeStudio *CozeStudioService
}

func (s *DataSyncService) SyncUserUpdate(userID string, userData interface{}) error {
    // 1. æ›´æ–°CozeRightsæ•°æ®
    err := s.cozeRights.UpdateUser(userID, userData)
    if err != nil {
        return err
    }
    
    // 2. åŒæ­¥åˆ°Coze-Studio
    return s.cozeStudio.UpdateUser(userID, userData)
}
```

## ğŸ” æƒé™é›†æˆæ–¹æ¡ˆ

### 1. ç»Ÿä¸€æƒé™æ¨¡å‹

#### 1.1 æƒé™æ˜ å°„è¡¨
```go
// æƒé™æ˜ å°„é…ç½®
var PermissionMapping = map[string]map[string]string{
    "coze-studio": {
        "space.read":   "workspace.read",
        "space.write":  "workspace.update",
        "space.admin":  "workspace.admin",
        "agent.read":   "agent.read",
        "agent.write":  "agent.create,agent.update",
        "agent.delete": "agent.delete",
    },
}

// æƒé™è½¬æ¢æœåŠ¡
type PermissionTranslator struct {
    mapping map[string]map[string]string
}

func (t *PermissionTranslator) TranslatePermission(source, permission string) []string {
    if mapping, exists := t.mapping[source]; exists {
        if translated, exists := mapping[permission]; exists {
            return strings.Split(translated, ",")
        }
    }
    return []string{permission} // é»˜è®¤è¿”å›åŸæƒé™
}
```

#### 1.2 æƒé™æ£€æŸ¥ä¸­é—´ä»¶
```go
// ç»Ÿä¸€æƒé™æ£€æŸ¥ä¸­é—´ä»¶
func UnifiedPermissionMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯
        userID := getUserID(c)
        
        // 2. è·å–èµ„æºä¿¡æ¯
        resourceType := getResourceType(c)
        resourceID := getResourceID(c)
        action := getAction(c)
        
        // 3. æ£€æŸ¥æƒé™
        hasPermission, err := checkUnifiedPermission(userID, resourceType, resourceID, action)
        if err != nil || !hasPermission {
            c.JSON(403, gin.H{"error": "Permission denied"})
            c.Abort()
            return
        }
        
        c.Next()
    }
}
```

### 2. å‰ç«¯æƒé™é›†æˆ

#### 2.1 æƒé™ä¸Šä¸‹æ–‡
```typescript
// æƒé™ä¸Šä¸‹æ–‡
interface PermissionContext {
  user: User;
  currentWorkspace: Workspace;
  permissions: Permission[];
  checkPermission: (resource: string, action: string) => boolean;
}

const PermissionProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [permissionContext, setPermissionContext] = useState<PermissionContext>();
  
  // æƒé™æ£€æŸ¥å‡½æ•°
  const checkPermission = useCallback((resource: string, action: string) => {
    // è°ƒç”¨CozeRights APIæ£€æŸ¥æƒé™
    return permissionAPI.checkPermission(resource, action);
  }, []);
  
  return (
    <PermissionContext.Provider value={{ ...permissionContext, checkPermission }}>
      {children}
    </PermissionContext.Provider>
  );
};
```

#### 2.2 æƒé™ç»„ä»¶
```typescript
// æƒé™æ§åˆ¶ç»„ä»¶
interface PermissionGateProps {
  resource: string;
  action: string;
  fallback?: React.ReactNode;
  children: React.ReactNode;
}

const PermissionGate: React.FC<PermissionGateProps> = ({
  resource,
  action,
  fallback = null,
  children
}) => {
  const { checkPermission } = usePermission();
  
  if (!checkPermission(resource, action)) {
    return <>{fallback}</>;
  }
  
  return <>{children}</>;
};

// ä½¿ç”¨ç¤ºä¾‹
<PermissionGate resource="agent" action="create">
  <CreateAgentButton />
</PermissionGate>
```

## ğŸ”„ ç”¨æˆ·ä½“éªŒæ•´åˆ

### 1. ç»Ÿä¸€ç™»å½•ä½“éªŒ

#### 1.1 å•ç‚¹ç™»å½•(SSO)
```go
// SSOæœåŠ¡
type SSOService struct {
    jwtService    *JWTService
    sessionStore  SessionStore
    userService   *UserService
}

func (s *SSOService) Login(email, password string) (*LoginResponse, error) {
    // 1. éªŒè¯ç”¨æˆ·å‡­æ®
    user, err := s.userService.ValidateCredentials(email, password)
    if err != nil {
        return nil, err
    }
    
    // 2. ç”ŸæˆJWT Token
    token, err := s.jwtService.GenerateToken(user)
    if err != nil {
        return nil, err
    }
    
    // 3. åˆ›å»ºä¼šè¯
    session := &Session{
        UserID:    user.ID,
        Token:     token,
        ExpiresAt: time.Now().Add(24 * time.Hour),
    }
    s.sessionStore.Save(session)
    
    // 4. è¿”å›ç™»å½•å“åº”
    return &LoginResponse{
        Token:     token,
        User:      user.ToResponse(),
        Workspace: s.getDefaultWorkspace(user.ID),
    }, nil
}
```

#### 1.2 å·¥ä½œç©ºé—´åˆ‡æ¢
```typescript
// å·¥ä½œç©ºé—´åˆ‡æ¢ç»„ä»¶
const WorkspaceSwitcher: React.FC = () => {
  const { currentWorkspace, workspaces, switchWorkspace } = useWorkspace();
  
  const handleWorkspaceChange = async (workspaceId: string) => {
    try {
      // 1. åˆ‡æ¢å·¥ä½œç©ºé—´
      await switchWorkspace(workspaceId);
      
      // 2. åˆ·æ–°æƒé™
      await refreshPermissions();
      
      // 3. é‡å®šå‘åˆ°å·¥ä½œç©ºé—´é¦–é¡µ
      navigate(`/workspace/${workspaceId}`);
    } catch (error) {
      notification.error('åˆ‡æ¢å·¥ä½œç©ºé—´å¤±è´¥');
    }
  };
  
  return (
    <Select
      value={currentWorkspace?.id}
      onChange={handleWorkspaceChange}
      placeholder="é€‰æ‹©å·¥ä½œç©ºé—´"
    >
      {workspaces.map(workspace => (
        <Option key={workspace.id} value={workspace.id}>
          {workspace.name}
        </Option>
      ))}
    </Select>
  );
};
```

### 2. ç®¡ç†ç•Œé¢é›†æˆ

#### 2.1 ä¼ä¸šç®¡ç†åå°
```typescript
// ä¼ä¸šç®¡ç†è·¯ç”±
const EnterpriseRoutes: React.FC = () => {
  return (
    <Routes>
      <Route path="/enterprise" element={<EnterpriseLayout />}>
        <Route path="tenants" element={<TenantManagement />} />
        <Route path="users" element={<UserManagement />} />
        <Route path="workspaces" element={<WorkspaceManagement />} />
        <Route path="permissions" element={<PermissionManagement />} />
        <Route path="audit" element={<AuditLogManagement />} />
      </Route>
    </Routes>
  );
};
```

#### 2.2 æƒé™ç®¡ç†ç•Œé¢
```typescript
// æƒé™ç®¡ç†ç»„ä»¶
const PermissionManagement: React.FC = () => {
  const [selectedResource, setSelectedResource] = useState<string>();
  const [permissions, setPermissions] = useState<Permission[]>([]);
  
  return (
    <div className="permission-management">
      <div className="resource-tree">
        <ResourceTree
          onResourceSelect={setSelectedResource}
          selectedResource={selectedResource}
        />
      </div>
      
      <div className="permission-matrix">
        <PermissionMatrix
          resourceId={selectedResource}
          permissions={permissions}
          onPermissionChange={handlePermissionChange}
        />
      </div>
    </div>
  );
};
```

## ğŸ“Š æ•°æ®å…¼å®¹æ€§ç­–ç•¥

### 1. æ•°æ®æ¨¡å‹æ˜ å°„

#### 1.1 IDæ˜ å°„è¡¨
```sql
-- IDæ˜ å°„è¡¨
CREATE TABLE id_mappings (
    id SERIAL PRIMARY KEY,
    source_system VARCHAR(50) NOT NULL,  -- 'coze-studio', 'cozerights'
    source_id VARCHAR(100) NOT NULL,     -- åŸç³»ç»ŸID
    target_system VARCHAR(50) NOT NULL,  -- ç›®æ ‡ç³»ç»Ÿ
    target_id VARCHAR(100) NOT NULL,     -- ç›®æ ‡ç³»ç»ŸID
    resource_type VARCHAR(50) NOT NULL,  -- 'user', 'workspace', 'agent', etc.
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(source_system, source_id, target_system, resource_type)
);
```

#### 1.2 æ•°æ®è½¬æ¢æœåŠ¡
```go
// æ•°æ®è½¬æ¢æœåŠ¡
type DataTransformService struct {
    idMappingRepo IDMappingRepository
}

func (s *DataTransformService) TransformUser(cozeUser *CozeStudioUser) (*models.User, error) {
    return &models.User{
        Username:   cozeUser.UserUniqueName,
        Email:      cozeUser.Email,
        TenantID:   s.getDefaultTenantID(),
        SystemRole: "user",
        IsActive:   true,
        // ä¿å­˜æ˜ å°„å…³ç³»
        ExternalID: cozeUser.UserID,
    }, nil
}
```

### 2. APIå…¼å®¹æ€§ä¿è¯

#### 2.1 ç‰ˆæœ¬å…¼å®¹ç­–ç•¥
```go
// APIç‰ˆæœ¬å…¼å®¹å¤„ç†
type APIVersionHandler struct {
    v1Handler *CozeRightsHandler
    v2Handler *UnifiedHandler
    legacyHandler *CozeStudioHandler
}

func (h *APIVersionHandler) HandleRequest(c *gin.Context) {
    version := c.GetHeader("API-Version")
    
    switch version {
    case "v1":
        h.v1Handler.Handle(c)
    case "v2":
        h.v2Handler.Handle(c)
    case "legacy", "":
        h.legacyHandler.Handle(c)
    default:
        c.JSON(400, gin.H{"error": "Unsupported API version"})
    }
}
```

---

**æ•´åˆç­–ç•¥ç‰ˆæœ¬**ï¼šv1.0.0  
**åˆ¶å®šæ—¶é—´**ï¼š2025-01-02  
**åˆ¶å®šè€…**ï¼šCozeRightså¼€å‘å›¢é˜Ÿ
